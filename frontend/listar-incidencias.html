<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Incidencias - Sistema de Incidencias IT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .priority-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .incident-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .incident-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-wrench-adjustable"></i> Sistema de Incidencias IT
            </a>
            <div class="d-flex align-items-center">
                <span class="navbar-text text-white me-3">
                    <i class="bi bi-person-circle"></i> 
                    <strong id="currentUsername"></strong>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Breadcrumb y acciones -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="dashboard.html" class="text-decoration-none">Dashboard</a></li>
                            <li class="breadcrumb-item active">Mis Incidencias</li>
                        </ol>
                    </nav>
                    <a href="crear-incidencia.html" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Incidencia
                    </a>
                </div>

                <!-- Filtros -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel"></i> Filtros y Búsqueda
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Búsqueda -->
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-search"></i> Buscar
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="searchInput"
                                    placeholder="Buscar por título o descripción...">
                            </div>

                            <!-- Filtro por estado -->
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-flag"></i> Estado
                                </label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Todos</option>
                                    <option value="1">Abierto</option>
                                    <option value="2">En Progreso</option>
                                    <option value="3">Resuelto</option>
                                    <option value="4">Cerrado</option>
                                </select>
                            </div>

                            <!-- Filtro por prioridad -->
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-exclamation-triangle"></i> Prioridad
                                </label>
                                <select class="form-select" id="priorityFilter">
                                    <option value="">Todas</option>
                                    <option value="1">Baja</option>
                                    <option value="2">Media</option>
                                    <option value="3">Alta</option>
                                    <option value="4">Crítica</option>
                                </select>
                            </div>

                            <!-- Botón filtrar -->
                            <div class="col-md-2">
                                <label class="form-label d-block">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="loadIncidents()">
                                    <i class="bi bi-arrow-repeat"></i> Aplicar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas rápidas -->
                <div class="row mb-4" id="statsContainer">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="card-title">Total</h6>
                                <h2 id="statTotal">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h6 class="card-title">Abiertas</h6>
                                <h2 id="statOpen">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h6 class="card-title">En Progreso</h6>
                                <h2 id="statProgress">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h6 class="card-title">Resueltas</h6>
                                <h2 id="statResolved">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de incidencias -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> Mis Incidencias
                        </h5>
                        <span class="badge bg-light text-dark" id="incidentCount">0 incidencias</span>
                    </div>
                    <div class="card-body">
                        <!-- Loading -->
                        <div id="loadingContainer" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando incidencias...</p>
                        </div>

                        <!-- Mensaje sin resultados -->
                        <div id="noResultsContainer" class="d-none text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                            <h5 class="mt-3 text-muted">No se encontraron incidencias</h5>
                            <p class="text-muted">Intenta cambiar los filtros o crea una nueva incidencia</p>
                            <a href="crear-incidencia.html" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Crear Incidencia
                            </a>
                        </div>

                        <!-- Contenedor de incidencias -->
                        <div id="incidentsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalle -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i> Detalle de Incidencia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteIncident()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-primary" id="updateStatusBtn">
                        <i class="bi bi-arrow-right-circle"></i> Cambiar Estado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentUser = null;
        let currentIncidentId = null;

        // Verificar autenticación
        currentUser = checkAuth();
        if (currentUser) {
            document.getElementById('currentUsername').textContent = currentUser;
        }

        // Colores por estado
        const statusColors = {
            'Abierto': 'warning',
            'En Progreso': 'info',
            'Resuelto': 'success',
            'Cerrado': 'secondary'
        };

        // Colores por prioridad
        const priorityColors = {
            'Baja': 'secondary',
            'Media': 'primary',
            'Alta': 'warning',
            'Crítica': 'danger'
        };

        // Cargar incidencias al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadIncidents();
        });

        // Función para cargar incidencias
        async function loadIncidents() {
            const loadingContainer = document.getElementById('loadingContainer');
            const noResultsContainer = document.getElementById('noResultsContainer');
            const incidentsContainer = document.getElementById('incidentsContainer');
            
            // Mostrar loading
            loadingContainer.classList.remove('d-none');
            noResultsContainer.classList.add('d-none');
            incidentsContainer.innerHTML = '';

            try {
                // Construir URL con filtros
                let url = `${API_AUTH_URL}/incidents/user/${currentUser}`;
                const params = new URLSearchParams();
                
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const searchInput = document.getElementById('searchInput').value;
                
                if (statusFilter) params.append('status_id', statusFilter);
                if (priorityFilter) params.append('priority_id', priorityFilter);
                if (searchInput) params.append('search', searchInput);
                
                if (params.toString()) {
                    url = `${API_AUTH_URL}/incidents?username=${currentUser}&${params.toString()}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                // Ocultar loading
                loadingContainer.classList.add('d-none');

                if (data.incidents && data.incidents.length > 0) {
                    // Actualizar contador
                    document.getElementById('incidentCount').textContent = 
                        `${data.incidents.length} incidencia${data.incidents.length !== 1 ? 's' : ''}`;
                    
                    // Actualizar estadísticas
                    updateStats(data.incidents);
                    
                    // Renderizar incidencias
                    renderIncidents(data.incidents);
                } else {
                    // Sin resultados
                    noResultsContainer.classList.remove('d-none');
                    document.getElementById('incidentCount').textContent = '0 incidencias';
                }

            } catch (error) {
                loadingContainer.classList.add('d-none');
                incidentsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Error al cargar incidencias: ${error.message}
                    </div>`;
            }
        }

        // Actualizar estadísticas
        function updateStats(incidents) {
            const stats = {
                total: incidents.length,
                open: incidents.filter(i => i.status.id === 1).length,
                progress: incidents.filter(i => i.status.id === 2).length,
                resolved: incidents.filter(i => i.status.id === 3).length
            };
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statOpen').textContent = stats.open;
            document.getElementById('statProgress').textContent = stats.progress;
            document.getElementById('statResolved').textContent = stats.resolved;
        }

        // Renderizar incidencias
        function renderIncidents(incidents) {
            const container = document.getElementById('incidentsContainer');
            
            container.innerHTML = incidents.map(incident => `
                <div class="card incident-card mb-3" onclick="showIncidentDetail(${incident.id})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <h3 class="text-muted mb-0">#${incident.id}</h3>
                            </div>
                            <div class="col-md-5">
                                <h5 class="card-title mb-1">${incident.title}</h5>
                                <p class="card-text text-muted small mb-0">
                                    ${incident.description.substring(0, 100)}${incident.description.length > 100 ? '...' : ''}
                                </p>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="status-badge bg-${statusColors[incident.status.name]} text-${incident.status.name === 'Abierto' ? 'dark' : 'white'}">
                                    ${incident.status.name}
                                </span>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="priority-badge bg-${priorityColors[incident.priority.name]} text-white">
                                    ${incident.priority.name}
                                </span>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted">
                                    <i class="bi bi-calendar3"></i><br>
                                    ${new Date(incident.created_at).toLocaleDateString('es-PA')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar detalle de incidencia
        async function showIncidentDetail(incidentId) {
            currentIncidentId = incidentId;
            
            try {
                const response = await fetch(`${API_AUTH_URL}/incidents/${incidentId}`);
                const incident = await response.json();
                
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-muted">Incidencia #${incident.id}</h6>
                        <h4>${incident.title}</h4>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Estado:</strong><br>
                            <span class="status-badge bg-${statusColors[incident.status.name]} text-${incident.status.name === 'Abierto' ? 'dark' : 'white'}">
                                ${incident.status.name}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Prioridad:</strong><br>
                            <span class="priority-badge bg-${priorityColors[incident.priority.name]} text-white">
                                ${incident.priority.name}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Descripción:</strong>
                        <p class="mt-2">${incident.description}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Creado:</strong><br>
                            ${new Date(incident.created_at).toLocaleString('es-PA')}
                        </div>
                        <div class="col-md-4">
                            <strong>Actualizado:</strong><br>
                            ${new Date(incident.updated_at).toLocaleString('es-PA')}
                        </div>
                        <div class="col-md-4">
                            <strong>Resuelto:</strong><br>
                            ${incident.resolved_at ? new Date(incident.resolved_at).toLocaleString('es-PA') : 'Pendiente'}
                        </div>
                    </div>
                `;
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
                
            } catch (error) {
                alert('Error al cargar detalle: ' + error.message);
            }
        }

        // Eliminar incidencia
        async function deleteIncident() {
            if (!confirm('¿Estás seguro de eliminar esta incidencia?')) return;
            
            try {
                const response = await fetch(`${API_AUTH_URL}/incidents/${currentIncidentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Incidencia eliminada exitosamente');
                    bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
                    loadIncidents();
                } else {
                    alert('Error al eliminar incidencia');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Búsqueda en tiempo real
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                loadIncidents();
            }, 500);
        });
    </script>
</body>
</html>
